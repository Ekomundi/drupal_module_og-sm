<?php
/**
 * @file
 * Tests for the og_sm_path module.
 */

/**
 * Tests about the URL in/outbound alters.
 */
class OgSmPathUrlAlterTestCase extends OgSmWebTestCase {
  /**
   * The Site node to test with.
   *
   * @var object
   */
  private $nodeSite;

  /**
   * The Site node path.
   *
   * @var string
   */
  private $nodeSitePath;

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name' => t('Site Path URL alter'),
      'description' => t('Tests Site Path URL in/outbound alters.'),
      'group' => t('Organic Groups Site Manager'),
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {
    // Enable required modules.
    $modules = array('og_sm_path');
    parent::setUp($modules);

    $site_type = $this->ogSmCreateGroupNodeType();
    og_sm_site_type_add($site_type);
    $this->nodeSite = $this->ogSmCreateGroup($site_type);
    $this->nodeSitePath = 'test-site-path';
    og_sm_path_set($this->nodeSite, $this->nodeSitePath, FALSE);
  }

  /**
   * Test the hook_url_outbound_alter() implementation.
   */
  public function testUrlOutboundAlter() {
    $site_nid = $this->nodeSite->nid;

    // Test rewriting for non Site paths.
    $path = $path_expected = 'group/node/987654321/admin/content';
    $options = $options_expected = array(
      'query' => array(
        'destination' => $path,
      ),
    );
    og_sm_path_url_outbound_alter($path, $options, 'foo/bar');
    $this->assertEqual($path_expected, $path);
    $this->assertEqual($options_expected, $options);

    // Test rewriting admin path rewrite for a Site.
    $path = 'group/node/' . $site_nid . '/admin/test/me/456';
    $path_expected = $this->nodeSitePath . '/admin/test/me/456';
    $options = array();
    og_sm_path_url_outbound_alter($path, $options, 'foo/bar');
    $this->assertEqual($path_expected, $path);

    // Test rewriting the destination for admin paths.
    $options = array(
      'query' => array(
        'destination' => 'group/node/' . $site_nid . '/admin/test/me/456',
      ),
    );
    $options_expected = array(
      'query' => array(
        'destination' => $this->nodeSitePath . '/admin/test/me/456',
      ),
    );
    og_sm_path_url_outbound_alter($path, $options, 'foo/bar');
    $this->assertEqual($options_expected, $options);
  }

  /**
   * Test the hook_url_inbound_alter() implementation.
   */
  public function testUrlInboundAlter() {
    // Not a Site path.
    $path = 'content/test/45687266/admin/content';
    $path_expected = $path;
    og_sm_path_url_inbound_alter($path, 'foo/bar', 'en');
    $this->assertEqual($path_expected, $path);

    // Site path.
    $path = $this->nodeSitePath . '/admin/people/edit/456';
    $path_expected = 'group/node/' . $this->nodeSite->nid . '/admin/people/edit/456';
    og_sm_path_url_inbound_alter($path, 'foo/bar', 'nl');
    $this->assertEqual($path_expected, $path);

    // System AJAX path.
    $path = 'system/ajax';
    $path_expected = 'group/node/' . $this->nodeSite->nid . '/system/ajax';
    og_sm_path_url_inbound_alter($path, 'foo/bar', 'nl');
    $this->assertEqual($path_expected, $path);

    // Views AJAX path.
    $path = 'views/ajax';
    $path_expected = 'group/node/' . $this->nodeSite->nid . '/views/ajax';
    og_sm_path_url_inbound_alter($path, 'foo/bar', 'nl');
    $this->assertEqual($path_expected, $path);
  }

}
