<?php
/**
 * @file
 * Tests for the og_sm_context module.
 */

/**
 * Tests about the OG context provider.
 */
class OgSmContextTestCase extends OgSmWebTestCase {
  /**
   * Site node type.
   *
   * @var string
   */
  protected $siteType;

  /**
   * Site content node type.
   *
   * @var string
   */
  protected $siteContentType;

  /**
   * Default node outside any group.
   *
   * @var object
   */
  protected $nodeGlobal;

  /**
   * Node of a group type that is not a Site.
   *
   * @var object
   */
  protected $nodeGroup;

  /**
   * Content within a group that is not a Site.
   *
   * @var object
   */
  protected $nodeGroupContent;

  /**
   * Site node.
   *
   * @var object
   */
  protected $nodeSite;

  /**
   * Site Content node.
   *
   * @var object
   */
  protected $nodeSiteContent;

  /**
   * Site node path.
   *
   * @var string
   */
  protected $nodeSitePath;


  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return array(
      'name' => t('Site Context'),
      'description' => t('Tests Site Context functionality.'),
      'group' => t('Organic Groups Site Manager'),
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {
    // Enable required modules.
    $modules = array('og_sm_context');
    parent::setUp($modules);

    // Create non Site content.
    $this->nodeGlobal = $this->drupalCreateNode();

    // Create a default group content.
    $group_type = $this->ogSmCreateGroupNodeType('default_group');
    $this->nodeGroup = $this->ogSmCreateGroup($group_type);
    $group_content_type = $this->ogSmCreateGroupContentNodeType('default_group_content');
    $this->nodeGroupContent = $this->ogSmCreateGroupContent($group_content_type, array($this->nodeGroup));

    // Create the Site node.
    $this->siteType = $this->ogSmCreateGroupNodeType();
    og_sm_site_type_add($this->siteType);
    variable_set('pathauto_node_' . $this->siteType . '_pattern', '[node:title]');
    $this->nodeSite = $this->ogSmCreateGroup($this->siteType);
    $this->nodeSitePath = drupal_get_path_alias('node/' . $this->nodeSite->nid);

    // Create the Site content node.
    $this->siteContentType = $this->ogSmCreateGroupContentNodeType();
    variable_set('pathauto_node_' . $this->siteContentType . '_pattern', $this->nodeSitePath . '/[node:title]');
    $this->nodeSiteContent = $this->ogSmCreateGroupContent($this->siteContentType, array($this->nodeSite));
  }

  /**
   * Test Context Content handler that reacts on paths as node/[nid](/[action]).
   */
  public function testOgContextHandlerContent() {
    // Test content outside Site context.
    $_GET['q'] = 'node/' . $this->nodeGlobal->nid;
    $this->assertNull(og_sm_context_handler_content());
    $_GET['q'] = 'node/' . $this->nodeGroup->nid;
    $this->assertNull(og_sm_context_handler_content());
    $_GET['q'] = 'node/' . $this->nodeGroupContent->nid;
    $this->assertNull(og_sm_context_handler_content());

    // Expected result inside Site context.
    $expected = array('node' => array((int) $this->nodeSite->nid));

    // Test Site node.
    $_GET['q'] = 'node/' . $this->nodeSite->nid;
    $this->assertEqual($expected, og_sm_context_handler_content());
    $_GET['q'] = 'node/' . $this->nodeSite->nid . '/edit';
    $this->assertEqual($expected, og_sm_context_handler_content());

    // Test Site Content node.
    $_GET['q'] = 'node/' . $this->nodeSiteContent->nid;
    $this->assertEqual($expected, og_sm_context_handler_content());
    $_GET['q'] = 'node/' . $this->nodeSiteContent->nid . '/delete';
    $this->assertEqual($expected, og_sm_context_handler_content());
  }

  /**
   * Test the Context Admin handler that reacts on paths like group/node/[nid]/.
   */
  public function testOgContextHandlerAdmin() {
    // Test outside Site context.
    $_GET['q'] = 'group/node/' . $this->nodeGroup->nid;
    $this->assertNull(og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/' . $this->nodeGroup->nid . '/admin';
    $this->assertNull(og_sm_context_handler_admin());

    // Test rubbish paths.
    $_GET['q'] = 'group/node/abc/465';
    $this->assertNull(og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/4548744654984/admin';
    $this->assertNull(og_sm_context_handler_admin());
    $_GET['q'] = 'group/node';
    $this->assertNull(og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/';
    $this->assertNull(og_sm_context_handler_admin());

    // Test inside Site context.
    $site_nid = (int) $this->nodeSite->nid;
    $expected = array('node' => array($site_nid));

    $_GET['q'] = 'group/node/' . $site_nid;
    $this->assertEqual($expected, og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/' . $site_nid . '/';
    $this->assertEqual($expected, og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/' . $site_nid . '/admin';
    $this->assertEqual($expected, og_sm_context_handler_admin());
    $_GET['q'] = 'group/node/' . $site_nid . '/465';
    $this->assertEqual($expected, og_sm_context_handler_admin());
  }

  /**
   * Test Context Get handler that reacts on a GET parameter.
   */
  public function testOgContextHandlerGetParameter() {
    // Test without a parameter.
    $this->assertNull(og_sm_context_handler_get());

    // Test with an invalid parameter.
    $_GET['og_sm_context_site_id'] = 'foo';
    $this->assertNull(og_sm_context_handler_get());

    // Test a valid parameter.
    $site_nid = (int) $this->nodeSite->nid;
    $expected = array('node' => array($site_nid));
    $_GET['og_sm_context_site_id'] = $this->nodeGroup->nid;
    $this->assertEqual($expected, og_sm_context_handler_get());
  }
}
